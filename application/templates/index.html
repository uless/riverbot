<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Arizona Water Chatbot</title>
    <meta
      name="description"
      content="Arizona Water Chatbot is your trusted chatbot companion for all things related to water in the Grand Canyon State. Explore the challenges of drought, learn effective water conservation techniques, and explore innovative solutions to secure our desert oasis's precious resource. Let's dive in together and make a difference for Arizona's water future!"
    />
    <meta name="author" content="htmlGenerator" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="icon"
      type="image/png"
      href="static/images/favicon-196x196.png"
      sizes="196x196"
    />
    <script
      src="https://kit.fontawesome.com/822f43696b.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="static/css/styles.css" />

    <script src="static/js/utils.js"></script>
    <style>
      .minimal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        height: 150px;
        width: 100%;
        background: transparent;
        box-sizing: border-box;
      }

      /* Left: ASU Logo Box */
      .asu-logo-box {
        width: 200px;
        height: 80px;
        background: #ffffff;
        border: 1px solid #8c1d40;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
      }

      .asu-logo-img {
        height: auto;
        width: auto;
      }

      /* Right: Custom Icon */
      .top-right-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 60px;
      }

      .icon-img {
        height: 70px;
        width: 70px;
      }
      .chatbot-prompt {
        scrollbar-width: none; /* Firefox */
        overflow-y: scroll;
      }

      .chatbot-prompt::-webkit-scrollbar {
        display: none; /* Chrome, Safari */
      }
      body {
        background-image: url("../static/images/background.png");
        background-size: cover; /* Stretch both width and height */
        background-repeat: no-repeat;
        background-attachment: scroll; /* So it scrolls with the page */
        background-position: center center;
        margin: 0;
        padding: 0;
        height: 100vh;
      }

      .container-xl {
        overflow-y: auto;
        max-height: 100vh;
      }
    </style>
  </head>

  <!-- Google tag (gtag.js) -->
  <script
    async
    src="https://www.googletagmanager.com/gtag/js?id=G-28W41YFR82"
  ></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-28W41YFR82");
  </script>

  <body
    data-spy="scroll"
    data-target=".chatbot-prompt .welcome-message-scroll"
    data-bs-offset="147"
  >
    <header class="minimal-header">
      <!--<div class="asu-logo-box">
  <img src="../static/images/ASU_Sunburst.png" alt="ASU Logo" class="asu-logo-img">
</div>
   <div class="top-right-icon">
    <img src="../static/images/downIcon.png" alt="Icon" class="icon-img">
  </div> -->
    </header>

    <!-- Main body -->
    <main>
      <div class="">
        <div class="row">
          <div class="chatbot-prompt-container">
            <div
              class="chatbot-prompt"
              id="chatbot-prompt"
              data-bs-spy="scroll"
              data-bs-offset="0"
            >
              <div class="card left">
                <div class="card-body welcome-message">
                  <div class="row">
                    <div class="chat-row">
                      <!-- <div
                        class="col-xs-12 col-sm-12 col-md-2 col-lg-2 col-xl-2 col-2 d-flex flex-wrap justify-content-start ps-10"
                      > -->
                      <img class="waterdrop1" />
                      <!-- </div> -->
                      <div
                        class="col-xs-12 col-sm-12 col-md-10 col-lg-10 col-xl-10 col-10 welcome-message-body"
                      >
                        <!-- <div
                        class="col-xs-12 col-sm-12 col-md-10 col-lg-10 col-xl-10 col-10 welcome-message-body"
                      > -->
                        <p>
                          Hi, I am a River. I am here to explore water with you.
                          We can chat, wonder, and share stories. I hope this is
                          a space for you to get to know me better, and for me
                          to understand how waters shape your place and your
                          life.
                        </p>
                        <p>
                          Letâ€™s chat. You can just say hello, share a river
                          memory with me, or ask questions about me. We can
                          notice what water feels like where you are, and find
                          simple ways to care for it. I am excited for us to get
                          to know each other.
                        </p>
                        <p>Not sure where to start? Try one of these:</p>
                        <ol>
                          <li>Hi River, how are you?</li>
                          <li>
                            Tell me something I can do to help our rivers.
                          </li>
                          <li>
                            What is one thing about water you want me to know?
                          </li>
                          <li>What is it like being a river?</li>
                          <li>How do you feel about how people treat you?</li>
                          <li>
                            I love going to rivers because... [fill in the
                            blank]
                          </li>
                        </ol>

                        <!-- </div> -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Add transcription div here -->
            <div id="transcription" style="display: none"></div>

            <form
              autocomplete="off"
              onsubmit="return false"
              action="/chat_api"
              method="post"
              id="userBox"
              style="
                display: flex;
                align-items: center;
                --left-trim: clamp(12px, 4.5vw, 85px);
                margin-left: var(--left-trim);
                width: calc(100% - var(--left-trim));
              "
            >
              <div
                class="input-group mt-3"
                style="position: relative; flex-grow: 1"
              >
                <input
                  autocomplete="nope"
                  type="text"
                  id="user_query"
                  name="user_query"
                  class="input-chatbot-question form-control"
                  placeholder="Type your question here"
                  aria-label="Type your question here"
                  aria-describedby="basic-addon2"
                  style="padding-right: 90px; border-radius: 16px; height: 60px"
                />

                <button
                  class="btn btn-mic"
                  id="mic-button"
                  type="button"
                  style="
                    position: absolute;
                    right: 50px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                  "
                >
                  <!-- SVG icon here -->
                </button>

                <button
                  class="btn btn-submit"
                  id="submit-button"
                  type="button"
                  style="
                    position: absolute;
                    right: 0;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    z-index: 99;
                  "
                >
                  <i
                    class="fa fa-send"
                    style="color: #8c1d40; font-size: 30px"
                  ></i>
                </button>
              </div>
            </form>

            <!-- <p class="disclosure">
            <small>
              Free Research Preview. Arizona Water Chatbot may produce
              inaccurate information about people, places, or facts.</small>
            <small>Answers provided are not the official policy positions of Julie Wrigley Global Futures Laboratory,
              Arizona State University, or any affiliate organization of ASU.
            </small><br>
            <small><strong>~~Debug Purposes~~</strong></small><br>
            <small>Hostname: {{ hostname }}</small><br>
            <small>IP Address: {{ ip_address }}</small>
          </p>
          --></div>
          <!-- Water droplet logo and New chat button 
        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4 col-12 chatbot-guidelines">
          <div class="chatbot-welcome">
            <div class="row mb-4">
              <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-xs-12 col-3">
                <img class="waterdrop1" /> -->
          <!-- <img id="waterdropFeedback" class="waterdrop1" data-bs-toggle="popover" data-bs-content="Thanks for your feedback"  /> 
              </div> -->
          <!--
              <div class="col-xl-9 col-lg-9 col-md-12 col-sm-12 col-xs-12 chatbottext-cta">
                <span class="h5"><strong>Arizona Water Chatbot</strong></span>
                <div style="display: inline-flex; align-items: center;">
                <button type="button" class="btn btn-primary btn-lg btn-new-chat"
                  onclick="window.location.href='/'">New Chat</button> -->

          <button
            class="btn btn-mic"
            id="mic-button-2"
            type="button"
            onclick="window.location.href='/'"
            style="
              margin-left: 1px;
              background: none;
              border: none;
              display: inline-flex;
              align-items: center;
            "
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="45"
              height="45"
              viewBox="0 0 65 65"
              fill="none"
            >
              <circle
                cx="32.5"
                cy="32.5"
                r="30.2586"
                fill="url(#paint0_linear_71_443)"
                fill-opacity="0.9"
              />
              <path
                d="M40.0598 32.7222C40.1614 32.0569 40.6948 31.508 41.3677 31.508C42.0407 31.508 42.5952 32.0558 42.5123 32.7236C42.2709 34.6679 41.4381 36.4095 40.0139 37.9485C38.7484 39.3186 37.2756 40.2734 35.5954 40.8128C34.6536 41.1152 33.9215 41.9339 33.9215 42.923V44.5267C33.9215 45.3118 33.2851 45.9483 32.5 45.9483C31.7149 45.9483 31.0784 45.3118 31.0784 44.5267V42.923C31.0784 41.9339 30.3466 41.1147 29.4043 40.814C27.7143 40.2748 26.219 39.3196 24.9184 37.9485C23.5317 36.4095 22.7208 34.668 22.4858 32.7237C22.405 32.0557 22.9593 31.508 23.6323 31.508C24.3052 31.508 24.8389 32.0568 24.9376 32.7224C25.1733 34.3133 25.889 35.6712 27.0846 36.796C28.6189 38.1519 30.4241 38.8298 32.5 38.8298C34.5759 38.8298 36.3585 38.1519 37.8477 36.796C39.0796 35.6711 39.817 34.3132 40.0598 32.7222ZM30.74 22.6947V31.6436C30.74 32.0955 30.8979 32.5023 31.2138 32.8639C31.5749 33.1803 32.0036 33.3384 32.5 33.3384C32.9513 33.3384 33.3349 33.1803 33.6508 32.8639C34.0118 32.5475 34.1923 32.1407 34.1923 31.6436L34.26 22.6947C34.26 22.1975 34.0795 21.7907 33.7185 21.4744C33.3574 21.1128 32.9513 20.932 32.5 20.932C32.0487 20.932 31.6426 21.1128 31.2815 21.4744C30.9205 21.7907 30.74 22.1975 30.74 22.6947ZM35.5462 34.5587C34.6887 35.4175 33.6733 35.8468 32.5 35.8468C31.3267 35.8468 30.3113 35.4175 29.4538 34.5587C28.5964 33.7 28.1677 32.6831 28.1677 31.508V22.8302C28.1677 21.6551 28.5964 20.6382 29.4538 19.7795C30.3113 18.9207 31.3267 18.4914 32.5 18.4914C33.6733 18.4914 34.6887 18.9207 35.5462 19.7795C36.4036 20.6382 36.8323 21.6551 36.8323 22.8302V31.508C36.8323 32.6831 36.4036 33.7 35.5462 34.5587Z"
                fill="#FEFEFF"
              />
              <defs>
                <linearGradient
                  id="paint0_linear_71_443"
                  x1="32.5"
                  y1="2.24138"
                  x2="32.5"
                  y2="62.7586"
                  gradientUnits="userSpaceOnUse"
                >
                  <stop stop-color="#8C1D40" />
                  <stop offset="1" stop-color="#260811" stop-opacity="0.9" />
                </linearGradient>
              </defs>
            </svg>
          </button>
        </div>
      </div>

      <!-- About Water chatbot -->
      <!-- Chatbot Recent History -->
      <!-- <div class="row">
              <div class="col-12 chatbot-history">
                <b>History</b>
                <ul class="list-unstyled">
                  <li class="list-group-item pb-2"> <i class="fa-regular fa-comment-alt"></i>&nbsp;&nbsp;Water
                    policy questions
                  <li class="list-group-item pb-2"><i class="fa-regular fa-comment-alt"></i>&nbsp;&nbsp;Relation between
                    Lake Mead and Lake Powell</li>
                  <li class="list-group-item"> <i class="fa-regular fa-comment-alt"></i>&nbsp;&nbsp;Conservation
                    practices for residential owners</li>
                </ul>
              </div>
            </div> -->

      <div class="language-transcript-row row">
        <!-- Language Section -->
        <!-- <div class="col-12 col-md-6 language-section"> -->
        <!-- <p class="language-text">Language</p> -->
        <div class="language-toggle">
          <button
            class="language-button english-button active"
            id="english-button"
            onclick="window.location.href='/'"
          >
            ENGLISH
          </button>
          <button
            class="language-button spanish-button"
            id="spanish-button"
            onclick="window.location.href='/spanish'"
          >
            ESPAÃ‘OL
          </button>
        </div>
        <!-- </div> -->

        <!-- Transcript Section -->

        <!--<div class="col-12 col-md-6 transcript-section">
                <p class="transcript-heading">Chat Transcript</p>
                <button class="transcript-button" id="transcript-button">Download</button>
              </div>-->
      </div>

      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div
          id="liveToast"
          class="toast"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="toast-header">
            <strong class="me-auto">Bootstrap</strong>
            <small>11 mins ago</small>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="toast"
              aria-label="Close"
            ></button>
          </div>
          <div class="toast-body">Hello, world! This is a toast message.</div>
        </div>
      </div>
      <!-- </div> -->
    </main>

    <!-----adding script to handle audio to transcribe functionality------------------------>

    <script>
      const micButton = document.getElementById("mic-button");
      if (micButton) {
        micButton.style.display = "none";
      }

      const micButton2 = document.getElementById("mic-button-2");
      if (micButton2) {
        micButton2.style.display = "none";
      }

      const transcriptionDiv = document.getElementById("transcription");

      let socket;
      let mediaRecorder;
      let isRecording = false;

      const wsPort = window.location.port || 8000; // Use the current web page's port or default to 8000
      const wsHost = window.location.hostname;
      const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = `${wsProtocol}//${wsHost}:${wsPort}/transcribe`;

      micButton.addEventListener("click", toggleRecording);

      function toggleRecording() {
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      }

      function startRecording() {
        micButton.innerText = "Stop Recording";
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.addEventListener(
              "dataavailable",
              handleDataAvailable
            );
            mediaRecorder.start(500);

            socket = new WebSocket(wsUrl);

            console.log("MediaRecorder instance created");
            socket.addEventListener("open", () => {
              console.log("WebSocket established");
            });
            socket.addEventListener("error", (error) => {
              console.error(`WebSocket error ${error}`);
            });
            socket.addEventListener("message", handleSocketMessage);

            isRecording = true;
          })
          .catch((error) => {
            console.error("Error accessing microphone:", error);
            isRecording = false;
          });
      }

      function stopRecording() {
        micButton.innerText = "Start Recording";

        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          mediaRecorder.removeEventListener(
            "dataavailable",
            handleDataAvailable
          );
        }

        if (socket && socket.readyState === WebSocket.OPEN) {
          const closeEventString = JSON.stringify({ event: "close" });
          socket.send(closeEventString);
          socket.close();
        }

        isRecording = false;
      }

      function handleDataAvailable(event) {
        console.log("handleDataAvailable called");
        console.log("AUDIO: ", event.data);
        const chunkSize = 1024 * 2;
        if (event.data && socket.readyState === WebSocket.OPEN) {
          const reader = new FileReader();
          reader.onload = () => {
            const arrayBuffer = reader.result;
            const chunks = splitArrayBuffer(arrayBuffer, chunkSize);
            for (const chunk of chunks) {
              socket.send(chunk);
            }
          };
          reader.readAsArrayBuffer(event.data);
        }
      }

      function splitArrayBuffer(arrayBuffer, chunkSize) {
        const chunks = [];
        const view = new Uint8Array(arrayBuffer);
        for (let i = 0; i < view.byteLength; i += chunkSize) {
          const chunk = view.subarray(i, i + chunkSize);
          chunks.push(chunk);
        }
        return chunks;
      }

      function handleSocketMessage(event) {
        console.log("In handle socket message");
        console.log("Received WebSocket message:", event.data);
        try {
          const data = JSON.parse(event.data);
          console.log("Parsed data: ", data);
          transcriptionDiv.innerText = data.transcript;
          // Check if the message is from the user or the bot and display it accordingly
          if (data.type === "user") {
            displayUserMessage(data.transcript);
          } else if (data.type === "bot") {
            displayBotMessage(data.response, data.messageID);
          }
        } catch (error) {
          console.error("Error parsing WebSocket message:", error);
        }
      }

      document
        .getElementById("transcript-button")
        .addEventListener("click", function () {
          fetch("/session-transcript", {
            method: "POST", // or 'GET' if your server supports it
            credentials: "include", // Ensures cookies are sent with the request
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Success:", data);
              // You might want to redirect the user to the URL or open it in a new tab
              window.open(data.presigned_url, "_blank");
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });
    </script>
  </body>
  <footer></footer>
</html>
